trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*
      - dev
  # Optional path filters:
  # paths:
  #   include:
  #     - terragrunt/**
  #     - .azure/**
  #   exclude:
  #     - README.md
  #     - docs/**

pool:
  name: aws-agent

variables:
  - group: aws-credentials   # expects AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY / AWS_DEFAULT_REGION

stages:
  - stage: Format
    displayName: "Terraform Format Check"
    jobs:
      - job: FormatCheck
        steps:
          - checkout: self
          - script: terraform fmt -check -recursive
            displayName: "Check Terraform formatting"
            workingDirectory: $(System.DefaultWorkingDirectory)

  - stage: Lint
    displayName: "Terraform Lint Check"
    dependsOn: Format
    jobs:
      - job: LintCheck
        steps:
          - checkout: self
          - script: |
              tflint --init
              tflint --recursive
            displayName: "Run TFLint"
            workingDirectory: $(System.DefaultWorkingDirectory)
            # Optional: prevent scanning Terragrunt cache
            # env:
            #   TFLINT_CONFIG: $(System.DefaultWorkingDirectory)/.tflint.hcl

  - stage: Validate
    displayName: "Terragrunt Validate"
    dependsOn: Lint
    jobs:
      - job: Validate
        steps:
          - checkout: self
          - script: terragrunt run-all validate
            displayName: "Terragrunt Validate"
            workingDirectory: $(System.DefaultWorkingDirectory)/terragrunt/envs/dev
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

  - stage: Plan
    displayName: "Terragrunt Plan"
    dependsOn: Validate
    jobs:
      - job: Plan
        steps:
          - checkout: self
          - script: terragrunt run-all plan
            displayName: "Terragrunt Plan"
            workingDirectory: $(System.DefaultWorkingDirectory)/terragrunt/envs/dev
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

  - stage: Apply
    displayName: "Terragrunt Apply"
    dependsOn: Plan
    condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'))  # only manual runs apply
    jobs:
      - job: Apply
        steps:
          - checkout: self
          - script: terragrunt run-all apply -auto-approve
            displayName: "Terragrunt Apply"
            workingDirectory: $(System.DefaultWorkingDirectory)/terragrunt/envs/dev
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
